name: Download Workflow Logs

on:
  workflow_dispatch:

jobs:
  download-logs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Download logs of another workflow
        env:
          GITHUB_TOKEN: ${{ secrets.MY_SECRET_TOKEN }}
          WORKFLOW_RUN_ID: 12581139515
          REPO: pavvi17/helm-core-framework
        run: |
          # Fetch the logs
          echo "Downloading logs for workflow run ID: $WORKFLOW_RUN_ID"
          curl -L -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/repos/$REPO/actions/runs/$WORKFLOW_RUN_ID/logs" \
               -o logs.zip

          # Validate the response
          if [ ! -s logs.zip ]; then
            echo "Error: Logs file is empty. Check the workflow run ID and permissions."
            exit 1
          fi

          # Check if the downloaded file is a valid ZIP archive
          if ! unzip -tq logs.zip; then
            echo "Error: Downloaded file is not a valid ZIP archive."
            exit 1
          fi

          # Unzip the logs
          echo "Unzipping logs..."
          unzip logs.zip -d logs

          # List the contents of the logs directory
          echo "Logs downloaded and unzipped:"
          ls logs

      - name: Debug logs download
        run: |
          echo "Downloaded file contents:"

      - name: Upload Logs as Artifact
        uses: actions/upload-artifact@v3
        with:
          name: workflow-logs
          path: logs/
